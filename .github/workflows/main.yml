name: Video-platform-Backend  CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  ci:
    runs-on: ubuntu-latest
    container:
      image: node


    services:
      mysql:
          image: mysql:5.7
          env:
              MYSQL_ROOT_PASSWORD: "123456"
              MYSQL_DATABASE: video_platform_test
          ports:
              - 3306
          options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v1
      - name: Install & Tests
        run: |
          npm i --registry=https://registry.npm.taobao.org
          npm run db:migrate
          npm test
        env: 
          NODE_ENV: test
          MYSQL_HOST: mysql
          MYSQL_DB: 'video_platform_test'
#   cd:
#     runs-on: ubuntu-latest
#     needs: ci

#     steps:
#       - uses: actions/checkout@v1
#       - name: Docker login
#         run: docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
#       - name: Build
#         run: docker build -t back .
#       - name: Tags
#         run: |
#           docker tag back ${{ secrets.DOCKER_USER }}/back:${{ github.sha }}
#           docker tag back ${{ secrets.DOCKER_USER }}/back:latest
#       - name: Push
#         run: |
#           docker push ${{ secrets.DOCKER_USER }}/back:${{ github.sha }}
#           docker push ${{ secrets.DOCKER_USER }}/back:latest